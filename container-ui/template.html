<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Container Storage & Accessibility</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #666;
            font-size: 14px;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .data-row:last-child {
            border-bottom: none;
        }

        .data-label {
            font-weight: 600;
            color: #666;
            font-size: 13px;
        }

        .data-value {
            color: #333;
            font-size: 13px;
            font-family: 'Courier New', monospace;
            max-width: 60%;
            word-break: break-all;
            text-align: right;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
            margin-top: 10px;
            width: 100%;
        }

        .btn:hover {
            background: #5568d3;
        }

        .endpoint-list {
            list-style: none;
        }

        .endpoint-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .method {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            margin-right: 8px;
        }

        .method-get {
            background: #28a745;
            color: white;
        }

        .method-post {
            background: #007bff;
            color: white;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
        }

        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="containerTitle">üîê Container Storage & Accessibility</h1>
            <div class="subtitle" id="containerSubtitle">Loading container information...</div>
            <span class="status-badge status-active" id="statusBadge">‚óè Active</span>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-title">üì¶ Container Information</div>
                <div class="data-row">
                    <span class="data-label">Container ID:</span>
                    <span class="data-value" id="containerId">Loading...</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Type:</span>
                    <span class="data-value" id="containerType">Loading...</span>
                </div>
                <div class="data-row">
                    <span class="data-label">API Port:</span>
                    <span class="data-value" id="apiPort">Loading...</span>
                </div>
                <div class="data-row">
                    <span class="data-label">UI Port:</span>
                    <span class="data-value" id="uiPort">Loading...</span>
                </div>
            </div>

            <div class="card" id="keysCard" style="display: none;">
                <div class="card-title">üîë Keys</div>
                <div id="keysData">
                    <div class="loading">Loading keys...</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">üîê Cryptographic Parameters</div>
            <div id="cryptoParams">
                <div class="loading">Loading crypto parameters...</div>
            </div>
        </div>

        <div class="card" id="dkgResultsCard" style="display: none;">
            <div class="card-title">üîë DKG Results</div>
            <div id="dkgResults">
                <div class="loading">Loading DKG results...</div>
            </div>
        </div>

        <div class="card" id="didGenerationCard" style="display: none;">
            <div class="card-title">üÜî DID Generation (Client-Side)</div>
            <div id="didGeneration">
                <div style="padding: 15px; background: #e7f3ff; border: 1px solid #007bff; border-radius: 6px; margin-bottom: 15px;">
                    <p style="font-size: 13px; color: #495057; margin: 0;">
                        Generate your Decentralized Identifier (DID) using 12-word BIP39 mnemonic. All computation happens in your browser.
                    </p>
                </div>

                <button id="generateNewDID" class="btn" onclick="generateNewDID()" style="width: 100%; margin-bottom: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600;">
                    üé≤ Generate New DID
                </button>

                <div id="generatedDIDResult" style="display: none; margin-bottom: 20px;">
                    <div style="background: #d4edda; border: 1px solid #28a745; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                        <strong style="color: #155724;">‚úÖ DID Generated Successfully!</strong>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="font-size: 13px;">üîë Your Mnemonic (12 words):</strong>
                            <button class="btn" onclick="copyMnemonic()" style="padding: 4px 10px; font-size: 11px;">üìã Copy</button>
                        </div>
                        <div id="mnemonicDisplay" style="padding: 12px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 6px; font-family: monospace; font-size: 12px; word-wrap: break-word;"></div>
                        <p style="font-size: 11px; color: #856404; margin: 8px 0 0 0;">
                            ‚ö†Ô∏è Write this down! Not stored anywhere and cannot be recovered if lost.
                        </p>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="font-size: 13px;">üÜî Your DID (SHA-512):</strong>
                            <button class="btn" onclick="copyDID()" style="padding: 4px 10px; font-size: 11px;">üìã Copy</button>
                        </div>
                        <div id="didDisplay" style="padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; font-family: monospace; font-size: 10px; word-break: break-all; color: #495057;"></div>
                    </div>

                    <div id="markCompleteSection">
                        <button id="markCompleteBtn" class="btn" onclick="markDIDComplete()" style="width: 100%; padding: 12px; background: #28a745; color: white; font-weight: 600; font-size: 14px;">
                            ‚úÖ Mark DID Generation Complete
                        </button>
                        <p style="font-size: 11px; color: #6c757d; margin: 8px 0 0 0; text-align: center;">
                            Click this ONLY ONCE after you have safely saved your mnemonic
                        </p>
                    </div>

                    <div id="didCompletedMessage" style="display: none; padding: 12px; background: #d1ecf1; border: 1px solid #0c5460; border-radius: 6px; text-align: center;">
                        <strong style="color: #0c5460;">‚úÖ DID Generation Completed</strong>
                        <p style="font-size: 12px; color: #0c5460; margin: 5px 0 0 0;">You can no longer generate a new DID</p>
                    </div>
                </div>

                <div style="border-top: 1px solid #dee2e6; padding-top: 15px; margin-top: 15px;">
                    <button class="btn" onclick="toggleRecoverDID()" style="width: 100%; background: #17a2b8; color: white;">
                        üìù Recover DID from Mnemonic
                    </button>

                    <div id="recoverDIDSection" style="display: none; margin-top: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 13px;">Enter your 12-word mnemonic:</label>
                        <textarea id="mnemonicInput" rows="3" placeholder="word1 word2 word3 word4 word5 word6 word7 word8 word9 word10 word11 word12" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px; font-family: monospace; margin-bottom: 10px;"></textarea>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="recoverDIDFromMnemonic()" style="flex: 1; background: #28a745; color: white;">üîç Calculate DID</button>
                            <button class="btn" onclick="toggleRecoverDID()" style="background: #6c757d; color: white;">Cancel</button>
                        </div>

                        <div id="recoveredDIDResult" style="display: none; margin-top: 15px;">
                            <div style="background: #d4edda; border: 1px solid #28a745; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                                <strong style="color: #155724;">‚úÖ DID Recovered!</strong>
                            </div>
                            <div>
                                <strong style="font-size: 13px; display: block; margin-bottom: 8px;">üÜî Your DID:</strong>
                                <div id="recoveredDIDDisplay" style="padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; font-family: monospace; font-size: 10px; word-break: break-all; color: #495057;"></div>
                            </div>
                        </div>

                        <div id="recoverError" style="display: none; margin-top: 10px; padding: 10px; background: #f8d7da; border: 1px solid #dc3545; border-radius: 6px; color: #721c24; font-size: 12px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- WASM Status Indicator -->
        <div class="card" id="wasmStatusCard" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="card-title" style="border-bottom: 2px solid rgba(255,255,255,0.3); color: white;">
                üîß WebAssembly Status (Client-Side Computing)
            </div>
            <div style="padding: 10px 0;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <span style="font-size: 24px; margin-right: 10px;">‚úÖ</span>
                    <div>
                        <strong>DID WASM Module</strong><br>
                        <small id="didWasmStatus">Loading...</small>
                    </div>
                </div>
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <span style="font-size: 24px; margin-right: 10px;">‚úÖ</span>
                    <div>
                        <strong>PBC Crypto WASM Module</strong><br>
                        <small id="pbcWasmStatus">Loading...</small>
                    </div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 6px; margin-top: 10px;">
                    <strong>üîê Privacy Guarantee:</strong><br>
                    <small style="opacity: 0.9;">All cryptographic operations (DID generation, o-value, blind signatures) execute entirely in your browser. No sensitive data is ever sent to the server.</small>
                </div>
            </div>
        </div>

        <!-- Phase 8: Credential Issuance (Blind Signature) -->
        <div class="card" id="credentialCard" style="display: none;">
            <div class="card-title">üîê Credential Issuance (Blind Signature)</div>

            <!-- Step 1: Generate o-value -->
            <div id="oValueSection">
                <div style="padding: 15px; background: #e7f3ff; border: 1px solid #007bff; border-radius: 6px; margin-bottom: 15px;">
                    <p style="font-size: 13px; color: #495057; margin: 0;">
                        <strong>Step 1:</strong> Generate o-value (blinding factor) using 12-word mnemonic.
                    </p>
                </div>

                <button id="generateOValue" class="btn" onclick="generateOValue()" style="width: 100%; margin-bottom: 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; font-weight: 600;">
                    üé≤ Generate o-value
                </button>

                <div id="oValueResult" style="display: none; margin-bottom: 20px;">
                    <div style="background: #d4edda; border: 1px solid #28a745; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                        <strong style="color: #155724;">‚úÖ o-value Generated!</strong>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="font-size: 13px;">üîë o-value Mnemonic (12 words):</strong>
                            <button class="btn" onclick="copyOValueMnemonic()" style="padding: 4px 10px; font-size: 11px;">üìã Copy</button>
                        </div>
                        <div id="oValueMnemonicDisplay" style="padding: 12px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 6px; font-family: monospace; font-size: 12px; word-wrap: break-word;"></div>
                        <p style="font-size: 11px; color: #856404; margin: 8px 0 0 0;">
                            ‚ö†Ô∏è Save this! You'll need it later for unblinding.
                        </p>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <strong style="font-size: 13px;">üî¢ o-value (SHA-512):</strong>
                        <div id="oValueDisplay" style="padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; font-family: monospace; font-size: 10px; word-break: break-all; color: #495057; margin-top: 8px;"></div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Prepare Blind Sign -->
            <div id="prepareBlindSignSection" style="display: none; border-top: 1px solid #dee2e6; padding-top: 20px; margin-top: 20px;">
                <div style="padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; margin-bottom: 15px;">
                    <p style="font-size: 13px; color: #495057; margin: 0;">
                        <strong>Step 2:</strong> Prepare blind signature request. Enter your DID and o-value mnemonics.
                    </p>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 13px;">üÜî DID Mnemonic:</label>
                    <textarea id="didMnemonicInput" placeholder="word1 word2 word3 ... word12" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px; resize: vertical; min-height: 60px;"></textarea>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 13px;">üî¢ o-value Mnemonic:</label>
                    <textarea id="oValueMnemonicInput" placeholder="word1 word2 word3 ... word12" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px; resize: vertical; min-height: 60px;"></textarea>
                </div>

                <button id="prepareBlindSignBtn" class="btn" onclick="prepareBlindSign()" style="width: 100%; padding: 12px; background: #28a745; color: white; font-weight: 600; font-size: 14px;">
                    ‚ú® Prepare Blind Signature Request
                </button>

                <div id="prepareBlindSignResult" style="display: none; margin-top: 20px;">
                    <div style="background: #d4edda; border: 1px solid #28a745; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                        <strong style="color: #155724;">‚úÖ Blind Sign Request Prepared!</strong>
                        <p style="font-size: 12px; color: #155724; margin: 5px 0 0 0;">Request sent to trustees...</p>
                    </div>
                </div>

                <div id="prepareBlindSignError" style="display: none; margin-top: 15px; padding: 12px; background: #f8d7da; border: 1px solid #dc3545; border-radius: 6px; color: #721c24; font-size: 12px;"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">üíæ Container Data</div>
            <div id="storageData">
                <div class="loading">Loading storage data...</div>
            </div>
            <button class="btn" onclick="refreshData()">üîÑ Refresh Data</button>
        </div>
    </div>

    <!-- Load Emscripten WASM (UMD format) before ES6 modules -->
    <script src="./wasm/blindsign.js"></script>

    <script type="module">
        // Load WASM modules for DID generation and PrepareBlindSign (only for Voter containers)
        let wasmModule = null;
        let blindSignModule = null;
        let cryptoParams = null;
        const CONTAINER_TYPE_CHECK = '{{CONTAINER_TYPE}}';
        const UI_PORT = '{{UI_PORT}}';  // Define UI_PORT in module scope

        if (CONTAINER_TYPE_CHECK === 'Voter') {
            console.log('üöÄ Loading WASM modules for client-side cryptography...');
            console.log('üìç All cryptographic operations will run in YOUR BROWSER');

            try {
                // Load DID WASM module
                console.log('‚è≥ Loading DID WASM module...');
                const wasmStartTime = performance.now();
                const wasm = await import('./wasm/did_wasm.js');
                await wasm.default();
                const wasmEndTime = performance.now();
                wasmModule = wasm;
                console.log(`‚úÖ WASM DID module loaded in ${(wasmEndTime - wasmStartTime).toFixed(2)}ms`);
                console.log('   üì¶ Module size: ~309 KB');
                console.log('   üîß Functions available: generate_did, recover_did, generate_o_value');

                // Update UI
                document.getElementById('wasmStatusCard').style.display = 'block';
                document.getElementById('didWasmStatus').textContent = `Loaded (~309 KB, ${(wasmEndTime - wasmStartTime).toFixed(0)}ms)`;

                // Load PBC BlindSign WASM module
                // createBlindSignModule is now available globally from the script tag above
                console.log('‚è≥ Loading PBC BlindSign WASM module...');
                const pbcStartTime = performance.now();
                blindSignModule = await createBlindSignModule();
                const pbcEndTime = performance.now();
                console.log(`‚úÖ WASM BlindSign module loaded in ${(pbcEndTime - pbcStartTime).toFixed(2)}ms`);
                console.log('   üì¶ Module size: ~397 KB');
                console.log('   üîß PBC library compiled to WebAssembly');
                console.log('   üîê Pairing-based cryptography ready!');

                // Update UI
                document.getElementById('pbcWasmStatus').textContent = `Loaded (~397 KB, ${(pbcEndTime - pbcStartTime).toFixed(0)}ms)`;

                // Fetch crypto parameters from backend (via /storage endpoint)
                // Storage endpoint is on the UI port (same server serving this page)
                const response = await fetch(`http://localhost:${UI_PORT}/storage`);
                const data = await response.json();

                if (data.crypto_parameters && data.crypto_parameters_loaded) {
                    cryptoParams = data.crypto_parameters;
                    console.log('‚úÖ Crypto parameters loaded:', cryptoParams);

                    // Initialize PBC pairing with real parameters
                    const result = blindSignModule.ccall(
                        'init_pairing',
                        'number',
                        ['string', 'string', 'string', 'string', 'string'],
                        [
                            cryptoParams.pairing_params,
                            cryptoParams.prime_order,
                            cryptoParams.g1,
                            cryptoParams.g2,
                            cryptoParams.h1
                        ]
                    );

                    if (result === 0) {
                        console.log('‚úÖ PBC pairing initialized with backend parameters');
                    } else {
                        console.error('‚ùå Failed to initialize PBC pairing');
                    }
                } else {
                    console.warn('‚ö†Ô∏è Crypto parameters not available yet');
                }

                document.getElementById('didGenerationCard').style.display = 'block';
                document.getElementById('credentialCard').style.display = 'block';
            } catch (err) {
                console.error('Failed to load WASM modules:', err);
            }
        }

        // Expose modules globally
        window.wasmModule = wasmModule;
        window.blindSignModule = blindSignModule;
        window.cryptoParams = cryptoParams;
    </script>

    <script>
        // Configuration - will be replaced by container-specific values
        const CONTAINER_TYPE = '{{CONTAINER_TYPE}}';
        const API_PORT = '{{API_PORT}}';
        const UI_PORT = '{{UI_PORT}}';
        const CONTAINER_ID = '{{CONTAINER_ID}}';
        const ELECTION_ID = '{{ELECTION_ID}}';
        const VOTER_ID = '{{VOTER_ID}}';
        const TC_ID = '{{TC_ID}}';

        // DID Generation state
        let currentMnemonic = '';
        let currentDID = '';
        let voterStatus = null; // Will be fetched from backend API

        // Fetch voter status from backend API
        async function fetchVoterStatus() {
            if (!VOTER_ID || VOTER_ID === '') {
                console.warn('‚ö†Ô∏è VOTER_ID not set, cannot fetch status');
                return null;
            }

            try {
                const response = await fetch(`http://host.docker.internal:8080/api/voters/${VOTER_ID}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                voterStatus = await response.json();
                console.log('‚úÖ Voter status fetched from backend:', voterStatus);
                return voterStatus;
            } catch (error) {
                console.error('‚ùå Failed to fetch voter status:', error);
                return null;
            }
        }

        // DID Generation Functions
        function generateNewDID() {
            if (!window.wasmModule) {
                alert('WASM module not loaded');
                return;
            }

            try {
                console.log('üîµ Starting DID generation (CLIENT-SIDE WASM)...');
                console.log('üìç Execution location: Browser (WebAssembly)');
                console.log('üîê No server communication - everything happens in your browser!');

                const startTime = performance.now();
                const result = window.wasmModule.generate_did();
                const endTime = performance.now();

                console.log(`‚úÖ DID generated in ${(endTime - startTime).toFixed(2)}ms (Pure WASM)`);
                console.log('üìä Generated DID length:', result.did.length, 'chars');
                console.log('üìä Mnemonic words:', result.mnemonic.split(' ').length);
                console.log('üîí This computation happened entirely in your browser - no backend involved!');

                currentMnemonic = result.mnemonic;
                currentDID = result.did;

                document.getElementById('mnemonicDisplay').textContent = result.mnemonic;
                document.getElementById('didDisplay').textContent = result.did;
                document.getElementById('generatedDIDResult').style.display = 'block';
                document.getElementById('recoverDIDSection').style.display = 'none';
                document.getElementById('recoveredDIDResult').style.display = 'none';

                // Show success message with timing
                alert(`‚úÖ DID Generated!\n\n‚è±Ô∏è Computation time: ${(endTime - startTime).toFixed(2)}ms\nüîê Generated entirely in your browser using WebAssembly\nüìù Check console (F12) for details`);
            } catch (err) {
                alert('Failed to generate DID: ' + err.message);
                console.error('‚ùå WASM Error:', err);
            }
        }

        function toggleRecoverDID() {
            const section = document.getElementById('recoverDIDSection');
            const isVisible = section.style.display !== 'none';
            section.style.display = isVisible ? 'none' : 'block';

            if (!isVisible) {
                document.getElementById('mnemonicInput').value = '';
                document.getElementById('recoveredDIDResult').style.display = 'none';
                document.getElementById('recoverError').style.display = 'none';
                document.getElementById('generatedDIDResult').style.display = 'none';
            }
        }

        function recoverDIDFromMnemonic() {
            if (!window.wasmModule) {
                alert('WASM module not loaded');
                return;
            }

            const mnemonic = document.getElementById('mnemonicInput').value.trim();
            if (!mnemonic) {
                showRecoverError('Please enter a mnemonic phrase');
                return;
            }

            try {
                const result = window.wasmModule.recover_did(mnemonic);

                if (!result.valid) {
                    showRecoverError('Invalid mnemonic phrase. Please check your 12-word mnemonic.');
                    document.getElementById('recoveredDIDResult').style.display = 'none';
                    return;
                }

                document.getElementById('recoveredDIDDisplay').textContent = result.did;
                document.getElementById('recoveredDIDResult').style.display = 'block';
                document.getElementById('recoverError').style.display = 'none';
            } catch (err) {
                showRecoverError('Failed to recover DID: ' + err.message);
                console.error(err);
            }
        }

        function showRecoverError(message) {
            const errorDiv = document.getElementById('recoverError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function copyMnemonic() {
            navigator.clipboard.writeText(currentMnemonic)
                .then(() => alert('Mnemonic copied to clipboard!'))
                .catch(err => console.error('Failed to copy:', err));
        }

        function copyDID() {
            navigator.clipboard.writeText(currentDID)
                .then(() => alert('DID copied to clipboard!'))
                .catch(err => console.error('Failed to copy:', err));
        }

        // o-value generation functions
        let currentOValueMnemonic = '';
        let currentOValue = '';

        function generateOValue() {
            if (!window.wasmModule) {
                alert('WASM module not loaded. Please refresh the page.');
                return;
            }

            const button = document.getElementById('generateOValue');
            button.disabled = true;
            button.textContent = 'Generating o-value...';

            try {
                console.log('üîµ Starting o-value generation (CLIENT-SIDE WASM)...');
                console.log('üìç Execution location: Browser (WebAssembly)');

                const startTime = performance.now();
                const result = window.wasmModule.generate_o_value();
                const endTime = performance.now();

                console.log(`‚úÖ o-value generated in ${(endTime - startTime).toFixed(2)}ms (Pure WASM)`);
                console.log('üîí Blinding factor generated locally - zero server knowledge!');

                currentOValueMnemonic = result.mnemonic;
                currentOValue = result.did; // The 'did' field holds o_value

                // Display mnemonic
                const mnemonicDisplay = document.getElementById('oValueMnemonicDisplay');
                mnemonicDisplay.innerHTML = `
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-top: 15px;">
                        <strong style="color: #856404; display: block; margin-bottom: 10px;">üîë o-value Mnemonic (SAVE THIS!):</strong>
                        <div style="font-family: monospace; font-size: 14px; background: white; padding: 12px; border-radius: 4px; word-break: break-word; color: #333;">
                            ${result.mnemonic}
                        </div>
                        <button onclick="copyOValueMnemonic()" style="margin-top: 10px; background: #ffc107; color: #333; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                            üìã Copy Mnemonic
                        </button>
                    </div>
                `;

                // Display o-value
                const oValueDisplay = document.getElementById('oValueDisplay');
                oValueDisplay.innerHTML = `
                    <div style="background: #d1ecf1; border: 2px solid #17a2b8; border-radius: 8px; padding: 15px; margin-top: 10px;">
                        <strong style="color: #0c5460; display: block; margin-bottom: 10px;">üîê o-value (SHA-512 hash):</strong>
                        <div style="font-family: monospace; font-size: 11px; background: white; padding: 12px; border-radius: 4px; word-break: break-all; color: #333;">
                            ${result.did}
                        </div>
                    </div>
                `;

                // Show results
                document.getElementById('oValueResult').style.display = 'block';

                // Show PrepareBlindSign section
                document.getElementById('prepareBlindSignSection').style.display = 'block';

                // Store in memory (no localStorage - user should save their mnemonic)
                // Session-only storage, will be lost on page refresh
                console.log('üíæ o-value stored in memory (session only)');

                // Update button
                button.textContent = '‚úÖ o-value Generated';
                button.disabled = false;

            } catch (error) {
                console.error('Error generating o-value:', error);
                alert('Failed to generate o-value: ' + error.message);
                button.disabled = false;
                button.textContent = 'üé≤ Generate o-value';
            }
        }

        function copyOValueMnemonic() {
            navigator.clipboard.writeText(currentOValueMnemonic)
                .then(() => alert('o-value mnemonic copied to clipboard!'))
                .catch(err => console.error('Failed to copy:', err));
        }

        async function prepareBlindSign() {
            if (!window.wasmModule || !window.blindSignModule) {
                alert('WASM modules not loaded. Please refresh the page.');
                return;
            }

            if (!window.cryptoParams) {
                alert('Crypto parameters not loaded. Please wait for setup phase to complete.');
                return;
            }

            // Get input values
            const didMnemonic = document.getElementById('didMnemonicInput').value.trim();
            const oValueMnemonic = document.getElementById('oValueMnemonicInput').value.trim();

            if (!didMnemonic || !oValueMnemonic) {
                alert('Please enter both DID mnemonic and o-value mnemonic');
                return;
            }

            const button = document.getElementById('prepareBlindSignBtn');
            button.disabled = true;
            button.textContent = '‚è≥ Preparing blind signature request...';

            try {
                // Recover DID from mnemonic
                const didResult = window.wasmModule.recover_did(didMnemonic);
                if (!didResult.valid) {
                    alert('Invalid DID mnemonic. Please check your 12-word mnemonic.');
                    button.disabled = false;
                    button.textContent = '‚ú® Prepare Blind Signature Request';
                    return;
                }

                // Recover o-value from mnemonic
                const oValueResult = window.wasmModule.recover_o_value(oValueMnemonic);
                if (!oValueResult.valid) {
                    alert('Invalid o-value mnemonic. Please check your 12-word mnemonic.');
                    button.disabled = false;
                    button.textContent = '‚ú® Prepare Blind Signature Request';
                    return;
                }

                // Call PBC PrepareBlindSign WASM function (Algorithm 4 with REAL PBC params)
                console.log('üîµ Starting PrepareBlindSign (CLIENT-SIDE WASM with PBC)...');
                console.log('üìç Execution location: Browser (WebAssembly + PBC Crypto)');
                console.log('üîê Input DID:', didResult.did.substring(0, 32) + '...');
                console.log('üîê Input o-value:', oValueResult.did.substring(0, 32) + '...');
                console.log('‚ö° Using pairing-based cryptography (PBC library compiled to WASM)');

                const startTime = performance.now();

                // Call C function via Emscripten ccall
                const resultPtr = window.blindSignModule.ccall(
                    'prepare_blind_sign',
                    'string',
                    ['string', 'string'],
                    [didResult.did, oValueResult.did]
                );

                const endTime = performance.now();

                // Parse JSON result
                const blindSignResult = JSON.parse(resultPtr);

                console.log(`‚úÖ PrepareBlindSign completed in ${(endTime - startTime).toFixed(2)}ms (Pure WASM + PBC)`);
                console.log('üîí Zero-knowledge proof generated locally!');
                console.log('üìä Commitment:', blindSignResult.com.substring(0, 32) + '...');
                console.log('üìä Proof components:', Object.keys(blindSignResult.proof).join(', '));

                // Display result
                const resultDiv = document.createElement('div');
                resultDiv.className = 'success';
                resultDiv.style.marginTop = '15px';
                resultDiv.innerHTML = `
                    <strong>‚úÖ Blind Signature Request Prepared!</strong><br><br>
                    <div style="text-align: left; font-size: 11px;">
                        <strong>Commitment (com):</strong><br>
                        <code style="word-break: break-all; font-size: 9px;">${blindSignResult.com}</code><br><br>

                        <strong>Initial Commitment (com_i):</strong><br>
                        <code style="word-break: break-all; font-size: 9px;">${blindSignResult.com_i}</code><br><br>

                        <strong>Hash Point (h):</strong><br>
                        <code style="word-break: break-all; font-size: 9px;">${blindSignResult.h}</code><br><br>

                        <strong>Zero-Knowledge Proof (KoR):</strong><br>
                        <div style="margin-left: 10px; font-size: 9px;">
                            <strong>c:</strong> <code style="word-break: break-all;">${blindSignResult.proof.c}</code><br>
                            <strong>s1:</strong> <code style="word-break: break-all;">${blindSignResult.proof.s1}</code><br>
                            <strong>s2:</strong> <code style="word-break: break-all;">${blindSignResult.proof.s2}</code><br>
                            <strong>s3:</strong> <code style="word-break: break-all;">${blindSignResult.proof.s3}</code><br>
                        </div><br>

                        <strong>Status:</strong> ‚úÖ Cryptographic proof generated successfully!<br>
                        <em style="color: #28a745;">Ready to request blind signatures from trustees</em>
                    </div>
                `;

                document.getElementById('prepareBlindSignSection').appendChild(resultDiv);

                // Store in memory (no localStorage - sensitive cryptographic data should not persist)
                // Session-only storage, will be lost on page refresh
                console.log('üíæ Blind signature request stored in memory (session only)');

                button.textContent = '‚úÖ Request Prepared';
                button.disabled = true;

                console.log('‚úÖ PrepareBlindSign completed:', blindSignResult);
                alert('ƒ∞≈ü bitti! üéâ\n\nCryptographic blind signature request prepared successfully!\n\nNext step: Request blind signatures from trustees.');

            } catch (error) {
                console.error('Error preparing blind sign:', error);
                alert('Failed to prepare blind signature request: ' + error.message);
                button.disabled = false;
                button.textContent = '‚ú® Prepare Blind Signature Request';
            }
        }

        async function markDIDComplete() {
            if (!VOTER_ID || !TC_ID) {
                alert('Error: Voter ID or TC ID not available');
                return;
            }

            if (!currentDID) {
                alert('Please generate a DID first');
                return;
            }

            const button = document.getElementById('markCompleteBtn');
            button.disabled = true;
            button.textContent = '‚è≥ Marking complete...';

            try {
                const response = await fetch(`http://host.docker.internal:8080/api/voters/${VOTER_ID}/did-complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tc_id: TC_ID })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const result = await response.json();

                if (result.success) {
                    // Hide the mark complete section
                    document.getElementById('markCompleteSection').style.display = 'none';

                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.className = 'success';
                    successDiv.innerHTML = `
                        ‚úÖ DID Generation Completed!<br>
                        <small>Progress: ${result.completed_count}/${result.total_voters} voters completed</small>
                    `;
                    document.getElementById('generatedDIDResult').appendChild(successDiv);

                    // Disable generate button
                    document.getElementById('generateNewDID').disabled = true;

                    alert(`DID generation marked as complete!\n${result.completed_count}/${result.total_voters} voters have completed DID generation.`);
                } else {
                    throw new Error(result.message || 'Failed to mark DID complete');
                }
            } catch (error) {
                console.error('Error marking DID complete:', error);
                alert(`Error: ${error.message}`);
                button.disabled = false;
                button.textContent = '‚úÖ Mark DID Generation Complete';
            }
        }

        // Check if DID generation was already completed (fetch from backend, NOT localStorage)
        async function checkDIDCompletionStatus() {
            if (CONTAINER_TYPE !== 'Voter') {
                return;
            }

            const status = await fetchVoterStatus();
            if (!status) {
                console.warn('‚ö†Ô∏è Could not fetch voter status, DID button will remain enabled');
                return;
            }

            if (status.did_generated) {
                console.log('üîí DID already generated for this voter, disabling button');

                // Disable generation
                const generateBtn = document.getElementById('generateNewDID');
                if (generateBtn) {
                    generateBtn.disabled = true;
                    generateBtn.style.opacity = '0.5';
                    generateBtn.style.cursor = 'not-allowed';
                }

                // Hide mark complete section
                const markCompleteSection = document.getElementById('markCompleteSection');
                if (markCompleteSection) {
                    markCompleteSection.style.display = 'none';
                }

                // Show completed message if DID result is visible
                const didResult = document.getElementById('generatedDIDResult');
                if (didResult && didResult.style.display !== 'none') {
                    const completedMsg = document.getElementById('didCompletedMessage');
                    if (completedMsg) {
                        completedMsg.style.display = 'block';
                    }
                }
            } else {
                console.log('‚úÖ DID not yet generated, button is enabled');
            }
        }

        // Initialize page
        async function initPage() {
            document.getElementById('containerTitle').textContent = `üîê ${CONTAINER_TYPE} Container`;
            document.getElementById('containerSubtitle').textContent = `Storage & Accessibility Dashboard`;
            document.getElementById('containerId').textContent = CONTAINER_ID || 'N/A';
            document.getElementById('containerType').textContent = CONTAINER_TYPE;
            document.getElementById('apiPort').textContent = API_PORT;
            document.getElementById('uiPort').textContent = UI_PORT;

            await loadStorageData();
            checkDIDCompletionStatus();
        }

        async function loadStorageData() {
            const storageDiv = document.getElementById('storageData');
            const cryptoDiv = document.getElementById('cryptoParams');

            try {
                // Try to fetch data from local UI server
                const response = await fetch(`http://localhost:${UI_PORT}/storage`);

                if (!response.ok) {
                    throw new Error('Failed to fetch storage data');
                }

                const data = await response.json();

                // Display crypto parameters separately
                if (data.crypto_parameters && data.crypto_parameters_loaded) {
                    displayCryptoParams(data.crypto_parameters);
                } else {
                    cryptoDiv.innerHTML = '<div class="error">‚ö†Ô∏è Crypto parameters not available</div>';
                }

                displayStorageData(data);
            } catch (error) {
                // If API not available, show sample data
                storageDiv.innerHTML = `
                    <div class="error">
                        API not available. Showing sample structure.
                    </div>
                    <pre>${JSON.stringify(getSampleData(), null, 2)}</pre>
                `;
                cryptoDiv.innerHTML = '<div class="error">‚ö†Ô∏è Unable to load crypto parameters</div>';
            }
        }

        function displayCryptoParams(params) {
            const cryptoDiv = document.getElementById('cryptoParams');

            const truncate = (str, len = 48) => {
                if (!str) return 'N/A';
                return str.length > len ? str.substring(0, len) + '...' : str;
            };

            cryptoDiv.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div class="data-row" style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                        <div>
                            <strong style="color: #495057; font-size: 13px; display: block; margin-bottom: 5px;">Election ID:</strong>
                            <span style="font-family: monospace; font-size: 11px; word-break: break-all; color: #6c757d;">${params.election_id || 'N/A'}</span>
                        </div>
                    </div>

                    <div class="data-row" style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                        <div>
                            <strong style="color: #495057; font-size: 13px; display: block; margin-bottom: 5px;">Security Level:</strong>
                            <span style="font-family: monospace; font-size: 12px; color: #28a745; font-weight: 600;">${params.security_level || 256} bits</span>
                        </div>
                    </div>

                    <div class="data-row" style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                        <div>
                            <strong style="color: #495057; font-size: 13px; display: block; margin-bottom: 5px;">Prime Order (q):</strong>
                            <span style="font-family: monospace; font-size: 11px; word-break: break-all; color: #6c757d;">${truncate(params.prime_order)}</span>
                        </div>
                    </div>

                    <div class="data-row" style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                        <div>
                            <strong style="color: #495057; font-size: 13px; display: block; margin-bottom: 5px;">Generator G1:</strong>
                            <span style="font-family: monospace; font-size: 11px; word-break: break-all; color: #6c757d;">${truncate(params.g1)}</span>
                        </div>
                    </div>

                    <div class="data-row" style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                        <div>
                            <strong style="color: #495057; font-size: 13px; display: block; margin-bottom: 5px;">Generator G2:</strong>
                            <span style="font-family: monospace; font-size: 11px; word-break: break-all; color: #6c757d;">${truncate(params.g2)}</span>
                        </div>
                    </div>

                    <div class="data-row" style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                        <div>
                            <strong style="color: #495057; font-size: 13px; display: block; margin-bottom: 5px;">Hash Point H1:</strong>
                            <span style="font-family: monospace; font-size: 11px; word-break: break-all; color: #6c757d;">${truncate(params.h1)}</span>
                        </div>
                    </div>

                    <div style="padding: 12px; background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 6px; margin-bottom: 10px;">
                        <strong style="color: #0c5460; font-size: 12px;">‚ÑπÔ∏è Info:</strong>
                        <p style="margin: 5px 0 0 0; font-size: 11px; color: #0c5460;">
                            These parameters are shared by all participants (TTP, Trustees, Voters) and generated using PBC Type A curves.
                        </p>
                    </div>
                </div>
                <button class="btn" onclick="showFullCryptoParams()" style="margin-top: 10px;">üìã Show Full Parameters</button>
            `;
        }

        function showFullCryptoParams() {
            fetch(`http://localhost:${UI_PORT}/storage`)
                .then(r => r.json())
                .then(data => {
                    const params = data.crypto_parameters;
                    const cryptoDiv = document.getElementById('cryptoParams');
                    cryptoDiv.innerHTML = `
                        <pre>${JSON.stringify(params, null, 2)}</pre>
                        <button class="btn" onclick="loadStorageData()">‚Ü©Ô∏è Back to Summary</button>
                    `;
                });
        }

        function displayStorageData(data) {
            const storageDiv = document.getElementById('storageData');
            const keysCard = document.getElementById('keysCard');
            const keysData = document.getElementById('keysData');

            // Check if this is DKG data for Trustee
            if (CONTAINER_TYPE === 'Trustee' && data.status) {
                displayDKGResults(data);
            }

            // Remove crypto params from storage display (shown separately)
            const { crypto_parameters, crypto_parameters_loaded, public_key, private_key_stored, ...displayData } = data;

            // Show keys card if public_key or private_key_stored exists
            if (public_key !== undefined || private_key_stored !== undefined) {
                keysCard.style.display = 'block';

                let keysHtml = '';
                if (public_key) {
                    keysHtml += `
                        <div class="data-row" style="background: #d4edda; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                            <div>
                                <strong style="color: #155724; font-size: 13px; display: block; margin-bottom: 5px;">üîì Public Key:</strong>
                                <span style="font-family: monospace; font-size: 11px; word-break: break-all; color: #155724;">${public_key}</span>
                            </div>
                        </div>
                    `;
                } else {
                    keysHtml += `
                        <div class="data-row" style="background: #fff3cd; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                            <div>
                                <strong style="color: #856404; font-size: 13px;">üîì Public Key:</strong>
                                <span style="font-size: 12px; color: #856404;"> Not generated yet</span>
                            </div>
                        </div>
                    `;
                }

                if (private_key_stored !== undefined) {
                    if (private_key_stored) {
                        keysHtml += `
                            <div class="data-row" style="background: #d4edda; padding: 12px; border-radius: 6px;">
                                <div>
                                    <strong style="color: #155724; font-size: 13px;">üîê Private Key:</strong>
                                    <span style="font-size: 12px; color: #155724;"> ‚úÖ Stored securely</span>
                                </div>
                            </div>
                        `;
                    } else {
                        keysHtml += `
                            <div class="data-row" style="background: #fff3cd; padding: 12px; border-radius: 6px;">
                                <div>
                                    <strong style="color: #856404; font-size: 13px;">üîê Private Key:</strong>
                                    <span style="font-size: 12px; color: #856404;"> ‚è≥ Not generated yet</span>
                                </div>
                            </div>
                        `;
                    }
                }

                keysData.innerHTML = keysHtml;
            }

            let html = '';
            for (const [key, value] of Object.entries(displayData)) {
                const displayValue = typeof value === 'object'
                    ? JSON.stringify(value).substring(0, 50) + '...'
                    : (value !== null && value !== undefined ? value.toString() : 'N/A');

                html += `
                    <div class="data-row">
                        <span class="data-label">${key.replace(/_/g, ' ').toUpperCase()}:</span>
                        <span class="data-value">${displayValue}</span>
                    </div>
                `;
            }

            storageDiv.innerHTML = html;
        }

        function displayDKGResults(data) {
            const dkgCard = document.getElementById('dkgResultsCard');
            const dkgDiv = document.getElementById('dkgResults');

            if (!data.status) {
                dkgCard.style.display = 'none';
                return;
            }

            dkgCard.style.display = 'block';

            const truncate = (str, len = 60) => {
                if (!str || str === 'null') return 'Not available';
                const strVal = typeof str === 'object' ? JSON.stringify(str) : str.toString();
                return strVal.length > len ? strVal.substring(0, len) + '...' : strVal;
            };

            const statusColor = {
                'idle': '#6c757d',
                'in_progress': '#ffc107',
                'completed': '#28a745',
                'failed': '#dc3545'
            };

            const statusIcon = {
                'idle': '‚è∏Ô∏è',
                'in_progress': '‚è≥',
                'completed': '‚úÖ',
                'failed': '‚ùå'
            };

            let html = `
                <div style="background: ${statusColor[data.status] || '#6c757d'}15; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ${statusColor[data.status] || '#6c757d'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 18px; font-weight: 700; color: ${statusColor[data.status] || '#6c757d'};">
                            ${statusIcon[data.status] || '‚Ä¢'} ${data.status === 'completed' ? 'KEYGEN COMPLETE' : 'Status: ' + data.status.toUpperCase()}
                        </span>
                        <span style="background: ${statusColor[data.status] || '#6c757d'}; color: white; padding: 6px 14px; border-radius: 12px; font-size: 13px; font-weight: 700;">
                            Step ${data.current_step}/7
                        </span>
                    </div>
                    <div style="font-size: 13px; color: #666;">
                        <strong>My Index:</strong> ${data.my_index || 'N/A'} |
                        <strong>Threshold:</strong> ${data.threshold || 'N/A'} |
                        <strong>Total Trustees:</strong> ${data.total_trustees || 'N/A'}
                    </div>
                </div>
            `;

            // Show MVK if available (PUBLIC)
            if (data.mvk) {
                html += `
                    <div style="background: #d1ecf1; border: 2px solid #17a2b8; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="color: #17a2b8; font-size: 14px; margin-bottom: 10px; display: flex; align-items: center;">
                            üîê Master Verification Key (MVK)
                            <span style="background: #17a2b8; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; margin-left: 10px;">PUBLIC</span>
                        </h3>
                        <div style="font-size: 11px; font-family: monospace; word-break: break-all; color: #0c5460;">
                            <div style="margin-bottom: 8px;"><strong>Œ±‚ÇÇ:</strong> ${truncate(data.mvk.alpha2)}</div>
                            <div style="margin-bottom: 8px;"><strong>Œ≤‚ÇÇ:</strong> ${truncate(data.mvk.beta2)}</div>
                            <div><strong>Œ≤‚ÇÅ:</strong> ${truncate(data.mvk.beta1)}</div>
                        </div>
                    </div>
                `;
            }

            // Show MY Verification Keys if available (PUBLIC)
            if (data.my_verification_keys) {
                html += `
                    <div style="background: #d4edda; border: 2px solid #28a745; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="color: #28a745; font-size: 14px; margin-bottom: 10px; display: flex; align-items: center;">
                            üîë My Verification Keys (VK_${data.my_index})
                            <span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; margin-left: 10px;">PUBLIC</span>
                        </h3>
                        <div style="font-size: 11px; font-family: monospace; word-break: break-all; color: #155724;">
                            <div style="margin-bottom: 8px;"><strong>VK‚ÇÅ:</strong> ${truncate(data.my_verification_keys.vk1)}</div>
                            <div style="margin-bottom: 8px;"><strong>VK‚ÇÇ:</strong> ${truncate(data.my_verification_keys.vk2)}</div>
                            <div><strong>VK‚ÇÉ:</strong> ${truncate(data.my_verification_keys.vk3)}</div>
                        </div>
                    </div>
                `;
            }

            // Show MY Signing Key if available (PRIVATE - only show that it exists)
            if (data.my_signing_key) {
                html += `
                    <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="color: #856404; font-size: 14px; margin-bottom: 10px; display: flex; align-items: center;">
                            üîê My Signing Key Share (SGK_${data.my_index})
                            <span style="background: #ffc107; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 10px; margin-left: 10px; font-weight: 600;">PRIVATE</span>
                        </h3>
                        <div style="font-size: 12px; color: #856404;">
                            ‚úÖ <strong>Signing key securely stored in this container</strong><br>
                            <small style="color: #6c757d;">This key is used to create threshold signatures and is never shared with anyone.</small>
                        </div>
                    </div>
                `;
            }

            // Show OTHER TRUSTEES' Verification Keys (PUBLIC) - for Trustees only
            if (CONTAINER_TYPE === 'Trustee' && data.other_trustees_vks && data.other_trustees_vks.length > 0) {
                html += `
                    <div style="background: #e7f3ff; border: 2px solid #007bff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="color: #007bff; font-size: 14px; margin-bottom: 12px; display: flex; align-items: center;">
                            üë• OTHER TRUSTEES' VERIFICATION KEYS
                            <span style="background: #007bff; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; margin-left: 10px;">PUBLIC</span>
                        </h3>
                `;

                data.other_trustees_vks.forEach((trustee, idx) => {
                    html += `
                        <div style="background: white; border: 1px solid #dee2e6; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: #495057; font-size: 13px;">Trustee ${trustee.index || idx + 1}</strong>
                                <span style="background: #e7f3ff; color: #007bff; padding: 3px 8px; border-radius: 8px; font-size: 10px; font-weight: 600;">VK_${trustee.index || idx + 1}</span>
                            </div>
                            <div style="font-size: 10px; font-family: monospace; word-break: break-all; color: #6c757d;">
                                <div style="margin-bottom: 6px;"><strong>VK‚ÇÅ:</strong> ${truncate(trustee.vk1, 50)}</div>
                                <div style="margin-bottom: 6px;"><strong>VK‚ÇÇ:</strong> ${truncate(trustee.vk2, 50)}</div>
                                <div><strong>VK‚ÇÉ:</strong> ${truncate(trustee.vk3, 50)}</div>
                            </div>
                        </div>
                    `;
                });

                html += `
                    </div>
                `;
            }

            // Show ALL TRUSTEES' Verification Keys and MVK for VOTERS
            if (CONTAINER_TYPE === 'Voter' && data.mvk) {
                html += `
                    <div style="background: #d1ecf1; border: 2px solid #17a2b8; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="color: #17a2b8; font-size: 14px; margin-bottom: 10px; display: flex; align-items: center;">
                            üîê Master Verification Key (MVK)
                            <span style="background: #17a2b8; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; margin-left: 10px;">PUBLIC</span>
                        </h3>
                        <div style="font-size: 11px; font-family: monospace; word-break: break-all; color: #0c5460;">
                            <div style="margin-bottom: 8px;"><strong>Œ±‚ÇÇ:</strong> ${truncate(data.mvk.alpha2)}</div>
                            <div style="margin-bottom: 8px;"><strong>Œ≤‚ÇÇ:</strong> ${truncate(data.mvk.beta2)}</div>
                            <div><strong>Œ≤‚ÇÅ:</strong> ${truncate(data.mvk.beta1)}</div>
                        </div>
                    </div>
                `;
            }

            if (CONTAINER_TYPE === 'Voter' && data.all_trustees_vks && data.all_trustees_vks.length > 0) {
                html += `
                    <div style="background: #e7f3ff; border: 2px solid #007bff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="color: #007bff; font-size: 14px; margin-bottom: 12px; display: flex; align-items: center;">
                            üë• ALL TRUSTEES' VERIFICATION KEYS
                            <span style="background: #007bff; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; margin-left: 10px;">PUBLIC</span>
                        </h3>
                `;

                data.all_trustees_vks.forEach((trustee, idx) => {
                    html += `
                        <div style="background: white; border: 1px solid #dee2e6; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: #495057; font-size: 13px;">Trustee ${trustee.index || idx + 1}</strong>
                                <span style="background: #e7f3ff; color: #007bff; padding: 3px 8px; border-radius: 8px; font-size: 10px; font-weight: 600;">VK_${trustee.index || idx + 1}</span>
                            </div>
                            <div style="font-size: 10px; font-family: monospace; word-break: break-all; color: #6c757d;">
                                <div style="margin-bottom: 6px;"><strong>VK‚ÇÅ:</strong> ${truncate(trustee.vk1, 50)}</div>
                                <div style="margin-bottom: 6px;"><strong>VK‚ÇÇ:</strong> ${truncate(trustee.vk2, 50)}</div>
                                <div><strong>VK‚ÇÉ:</strong> ${truncate(trustee.vk3, 50)}</div>
                            </div>
                        </div>
                    `;
                });

                html += `
                    </div>
                `;
            }

            // Show qualified set if available
            if (data.qualified_set && data.qualified_set.length > 0) {
                html += `
                    <div style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                        <strong style="color: #495057; font-size: 13px;">Qualified Trustees:</strong>
                        <div style="margin-top: 5px; font-family: monospace; font-size: 12px; color: #28a745;">
                            ${data.qualified_set.join(', ')}
                        </div>
                    </div>
                `;
            }

            // Show complaints if any
            if (data.complaints && data.complaints.length > 0) {
                html += `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 12px; border-radius: 6px;">
                        <strong style="color: #721c24; font-size: 13px;">‚ö†Ô∏è Complaints: ${data.complaints.length}</strong>
                    </div>
                `;
            }

            dkgDiv.innerHTML = html;
        }

        function getSampleData() {
            const samples = {
                'TTP': {
                    election_id: 'sample-election-id',
                    crypto_params: {
                        prime_order: '800000ff...',
                        g1: '147d308a...',
                        security_level: 256
                    },
                    status: 'active'
                },
                'Trustee': {
                    trustee_id: 'sample-trustee-id',
                    public_key: 'pk_123abc...',
                    status: 'active',
                    signatures_count: 0
                },
                'Voter': {
                    voter_id: 'sample-voter-id',
                    credential: 'cred_456def...',
                    has_voted: false,
                    status: 'registered'
                }
            };

            return samples[CONTAINER_TYPE] || { message: 'No sample data available' };
        }

        function refreshData() {
            loadStorageData();
        }

        // Initialize on page load
        initPage();
    </script>
</body>
</html>
